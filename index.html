<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/aframe/build/aframe-ar.js"></script>
    <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-detector.js"></script>
    <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-handler.js"></script>

    <style>
      /* Layout & Background Reset */
      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background-color: transparent;
      }

      /* AR Video Positioning */
      #arjs-video {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        z-index: -1;
      }

      /* UI Panel Styling */
      :root {
        --bg-panel: rgba(25, 25, 25, 0.9);
        --accent: #007aff;
      }

      #infoPanel {
        position: fixed;
        z-index: 9999;
        display: none;
        background: var(--bg-panel);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        color: white;
        padding: 20px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        font-family: sans-serif;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      }

      /* Responsive UI Panel */
      @media (min-width: 768px) {
        #infoPanel { left: 20px; bottom: 20px; width: 380px; border-radius: 16px; }
      }
      @media (max-width: 767px) {
        #infoPanel { 
          left: 10px; 
          right: 10px; 
          bottom: calc(10px + env(safe-area-inset-bottom)); 
          border-radius: 20px; 
        }
      }

      .title { font-weight: bold; font-size: 1.2rem; margin-bottom: 10px; display: flex; justify-content: space-between; }
      #infoClose { cursor: pointer; background: none; border: none; color: white; font-size: 20px; }
      .ctaRow { display: flex; gap: 10px; margin-top: 15px; }
      .btn { flex: 1; padding: 10px; text-align: center; border-radius: 8px; text-decoration: none; font-weight: bold; font-size: 13px; }
      .btn-primary { background: white; color: black; }
      .btn-sec { background: rgba(255, 255, 255, 0.1); color: white; }
    </style>

    <script>
      AFRAME.registerComponent("bezier-curve-3", {
        schema: {
          m0: { type: "selector" },
          m1: { type: "selector" },
          m2: { type: "selector" },
          segments: { type: "int", default: 64 },
          color: { type: "color", default: "#00ff00" },
          speed: { type: "number", default: 0.25 },
          loop: { type: "boolean", default: true },
          faceDirection: { type: "boolean", default: true }
        },

        init() {
          this.found = { m0: false, m1: false, m2: false };
          this.wasAllVisible = false;

          const hook = (key, el) => {
            if (!el) return;
            el.addEventListener("markerFound", () => { this.found[key] = true; });
            el.addEventListener("markerLost", () => {
              this.found[key] = false;
              this.wasAllVisible = false;
              this.hideLineAndMover();
            });
          };

          hook("m0", this.data.m0);
          hook("m1", this.data.m1);
          hook("m2", this.data.m2);

          // Initialize line visualization
          this.material = new THREE.LineBasicMaterial({ color: this.data.color, linewidth: 3 });
          this.geometry = new THREE.BufferGeometry();
          this.positions = new Float32Array((this.data.segments + 1) * 3);
          this.geometry.setAttribute("position", new THREE.BufferAttribute(this.positions, 3));
          this.line = new THREE.Line(this.geometry, this.material);
          this.el.sceneEl.object3D.add(this.line);
          this.line.visible = false;

          // Initialize animated mover
          this.mover = document.createElement("a-image");
          this.mover.setAttribute("src", "assets/assetPerson.png");
          this.mover.setAttribute("scale", "0.35 0.35 0.35");
          this.mover.setAttribute("rotation", "-90 0 0");
          this.el.sceneEl.appendChild(this.mover);
          this.mover.object3D.visible = false;

          this.t = 0;
          this.tmpP0 = new THREE.Vector3();
          this.tmpP1 = new THREE.Vector3();
          this.tmpP2 = new THREE.Vector3();
          this.tmpPos = new THREE.Vector3();
          this.tmpPos2 = new THREE.Vector3();
        },

        allVisible() {
          return this.found.m0 && this.found.m1 && this.found.m2;
        },

        hideLineAndMover() {
          if (this.line) this.line.visible = false;
          if (this.mover && this.mover.object3D) this.mover.object3D.visible = false;
        },

        tick(time, timeDelta) {
          if (!this.allVisible()) return;

          if (!this.wasAllVisible) {
            this.wasAllVisible = true;
            this.t = 0;
          }

          // Get markers world positions
          this.data.m0.object3D.getWorldPosition(this.tmpP0);
          this.data.m1.object3D.getWorldPosition(this.tmpP1);
          this.data.m2.object3D.getWorldPosition(this.tmpP2);

          const curve = new THREE.QuadraticBezierCurve3(this.tmpP0, this.tmpP1, this.tmpP2);

          // Update curve geometry
          const points = curve.getPoints(this.data.segments);
          for (let i = 0; i <= this.data.segments; i++) {
            this.positions[i * 3] = points[i].x;
            this.positions[i * 3 + 1] = points[i].y;
            this.positions[i * 3 + 2] = points[i].z;
          }
          this.geometry.attributes.position.needsUpdate = true;
          this.line.visible = true;

          // Path animation logic
          const dt = timeDelta / 1000;
          this.t += this.data.speed * dt;

          if (this.data.loop) {
            this.t = this.t % 1;
          } else {
            this.t = Math.min(this.t, 1);
          }

          curve.getPoint(this.t, this.tmpPos);
          this.mover.object3D.position.copy(this.tmpPos);
          this.mover.object3D.visible = true;

          // Rotation logic (Face direction)
          if (this.data.faceDirection) {
            const eps = 0.01;
            const t2 = Math.min(this.t + eps, 1);
            curve.getPoint(t2, this.tmpPos2);
            const dir = this.tmpPos2.clone().sub(this.tmpPos);
            
            if (dir.lengthSq() > 1e-8) {
              const yaw = Math.atan2(dir.x, dir.z);
              this.mover.object3D.rotation.set(-Math.PI / 2, yaw, 0);
            }
          }
        },
      });
    </script>
  </head>

  <body>
    <div id="infoPanel" role="dialog">
      <button id="infoClose" aria-label="Close">âœ•</button>
      <div class="title" id="infoTitle"></div>
      <div id="infoBody"></div>
    </div>

    <a-scene
      vr-mode-ui="enabled: false;"
      loading-screen="enabled: false;"
      arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
      embedded
      gesture-detector
    >
      <a-marker
        id="m0"
        type="pattern"
        preset="custom"
        url="assets/marker.patt"
        emitevents="true"
      >
        <a-image
          id="img-main"
          src="assets/asset.png"
          scale="1 1 1"
          rotation="-90 0 0"
          gesture-handler
        ></a-image>
      </a-marker>

      <a-marker
        id="m1"
        type="pattern"
        preset="custom"
        url="assets/markerApple.patt"
        emitevents="true"
      >
        <a-image
          id="img-apple"
          src="assets/assetApple.jpeg"
          scale="1 1 1"
          rotation="-90 0 0"
          gesture-handler
        ></a-image>
      </a-marker>

      <a-marker 
        id="m2" 
        type="pattern" 
        preset="custom" 
        url="assets/dot0.patt" 
        raycaster="objects: .clickable" 
        emitevents="true" 
        cursor="fuse: false; rayOrigin: mouse;"
      >
        <a-image
          src="assets/assetDot.png"
          scale="1 1 1"
          class="clickable"
          rotation="-90 0 0"
          gesture-handler
        ></a-image>
      </a-marker>

      <a-entity id="bezierCurve" bezier-curve-3="m0:#m0; m1:#m1; m2:#m2; segments:64"></a-entity>

      <a-entity camera></a-entity>
    </a-scene>

    <script>
      window.addEventListener("DOMContentLoaded", () => {
        const panel = document.getElementById("infoPanel");
        const titleEl = document.getElementById("infoTitle");
        const bodyEl = document.getElementById("infoBody");
        const closeBtn = document.getElementById("infoClose");

        const markerNike = document.getElementById("m0");
        const markerApple = document.getElementById("m1");

        let visibleMarkerId = null;

        function showInfo(title, bodyHtml) {
          titleEl.innerHTML = title;
          bodyEl.innerHTML = bodyHtml;
          panel.style.display = "block";
        }

        function hideInfo() {
          panel.style.display = "none";
        }

        closeBtn.addEventListener("click", () => {
          visibleMarkerId = null;
          hideInfo();
        });

        const content = {
          nike: {
            title: "Nike <span class='tag'>Detected</span>",
            html: `
              <p>Detected <b>Nike</b> marker. Sport style and performance technologies.</p>
              <ul>
                <li>Training and lifestyle apparel</li>
                <li>Comfort and breathability</li>
                <li>Performance collections</li>
              </ul>
              <div class="ctaRow">
                <a class="btn" href="https://www.nike.com/w/new-shoes" target="_blank">New Arrivals</a>
                <a class="btn" href="https://www.nike.com/" target="_blank">Visit Nike</a>
              </div>
            `
          },
          apple: {
            title: "Apple <span class='tag'>Detected</span>",
            html: `
              <p>Detected <b>Apple</b> marker. Ecosystem of devices and services.</p>
              <ul>
                <li>Apple Silicon: High performance</li>
                <li>Seamless experience: iPhone, Mac, iPad</li>
                <li>Privacy and security focused</li>
              </ul>
              <div class="ctaRow">
                <a class="btn" href="https://www.apple.com/iphone/" target="_blank">iPhone</a>
                <a class="btn" href="https://www.apple.com/mac/" target="_blank">Mac</a>
              </div>
            `
          }
        };

        markerNike.addEventListener("markerFound", () => {
          visibleMarkerId = "nike";
          showInfo(content.nike.title, content.nike.html);
        });
        markerNike.addEventListener("markerLost", () => {
          if (visibleMarkerId === "nike") {
            visibleMarkerId = null;
            hideInfo();
          }
        });

        markerApple.addEventListener("markerFound", () => {
          visibleMarkerId = "apple";
          showInfo(content.apple.title, content.apple.html);
        });
        markerApple.addEventListener("markerLost", () => {
          if (visibleMarkerId === "apple") {
            visibleMarkerId = null;
            hideInfo();
          }
        });
      });
    </script>
  </body>
</html>